# Модуль SMS API

## Обзор

Модуль SMS API предоставляет полную функциональность управления SMS-сообщениями, включая чтение, отправку и организацию сообщений. Поддерживает как локальное хранилище устройства, так и хранилище SIM-карты.

## Содержание

- [Количество SMS](#количество-sms)
- [Список SMS](#список-sms)
- [Отправка SMS](#отправка-sms)
- [Типы сообщений](#типы-сообщений)
- [Места хранения](#места-хранения)
- [Обработка ошибок](#обработка-ошибок)

## Количество SMS

### Получение количества SMS

Получает количество SMS-сообщений в различных категориях и местах хранения.

**Конечная точка**: `GET /api/sms/sms-count`

**Запрос**: Отсутствует

**Ответ**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <LocalUnread>1</LocalUnread>
    <LocalInbox>5</LocalInbox>
    <LocalOutbox>3</LocalOutbox>
    <LocalDraft>0</LocalDraft>
    <SimUnread>0</SimUnread>
    <SimInbox>0</SimInbox>
    <SimOutbox>0</SimOutbox>
    <SimDraft>0</SimDraft>
    <NewMsg>1</NewMsg>
</response>
```

#### Поля ответа

| Поле | Описание |
|------|----------|
| `LocalUnread` | Непрочитанные сообщения в локальном хранилище |
| `LocalInbox` | Всего сообщений во входящих в локальном хранилище |
| `LocalOutbox` | Отправленные сообщения в локальном хранилище |
| `LocalDraft` | Черновики в локальном хранилище |
| `SimUnread` | Непрочитанные сообщения на SIM-карте |
| `SimInbox` | Всего сообщений во входящих на SIM-карте |
| `SimOutbox` | Отправленные сообщения на SIM-карте |
| `SimDraft` | Черновики на SIM-карте |
| `NewMsg` | Всего новых (непрочитанных) сообщений |

## Список SMS

### Получение SMS-сообщений

Получает список SMS-сообщений с опциями пагинации и фильтрации.

**Конечная точка**: `POST /api/sms/sms-list`

**Запрос**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<request>
    <PageIndex>1</PageIndex>
    <ReadCount>20</ReadCount>
    <BoxType>1</BoxType>
    <SortType>0</SortType>
    <Ascending>0</Ascending>
    <UnreadPreferred>0</UnreadPreferred>
</request>
```

#### Параметры запроса

| Параметр | Описание | Значения |
|----------|----------|----------|
| `PageIndex` | Номер страницы (начиная с 1) | 1, 2, 3... |
| `ReadCount` | Сообщений на страницу | 1-50 |
| `BoxType` | Тип почтового ящика | См. [Типы ящиков](#типы-ящиков) |
| `SortType` | Критерий сортировки | 0=Дата, 1=Имя |
| `Ascending` | Порядок сортировки | 0=По убыванию, 1=По возрастанию |
| `UnreadPreferred` | Показать непрочитанные первыми | 0=Нет, 1=Да |

#### Типы ящиков

| Значение | Описание |
|----------|----------|
| `1` | Входящие |
| `2` | Отправленные/Исходящие |
| `3` | Черновики |

**Ответ**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <Count>5</Count>
    <Messages>
        <Message>
            <Smstat>3</Smstat>
            <Index>40000</Index>
            <Phone>+48500500500</Phone>
            <Content>Содержимое тестового сообщения</Content>
            <Date>2023-01-01 12:00:00</Date>
            <Sca></Sca>
            <SaveType>3</SaveType>
            <Priority>0</Priority>
            <SmsType>1</SmsType>
        </Message>
    </Messages>
</response>
```

#### Поля ответа

| Поле | Описание | Значения |
|------|----------|----------|
| `Count` | Общее количество возвращенных сообщений | Число |
| `Smstat` | Статус сообщения | См. [Статус сообщения](#статус-сообщения) |
| `Index` | Уникальный идентификатор сообщения | Число |
| `Phone` | Номер телефона отправителя/получателя | Номер телефона |
| `Content` | Текстовое содержимое сообщения | Текст |
| `Date` | Временная метка сообщения | YYYY-MM-DD HH:MM:SS |
| `Sca` | Адрес сервисного центра | Обычно пустой |
| `SaveType` | Место хранения | См. [Типы сохранения](#типы-сохранения) |
| `Priority` | Приоритет сообщения | 0=Обычный, 1=Высокий |
| `SmsType` | Тип сообщения | См. [Типы SMS](#типы-sms) |

#### Статус сообщения

| Значение | Описание |
|----------|----------|
| `0` | Непрочитанное |
| `1` | Прочитанное |
| `2` | Неотправленное |
| `3` | Отправленное |

#### Типы сохранения

| Значение | Описание |
|----------|----------|
| `3` | Локальное хранилище |
| `4` | SIM-карта |

#### Типы SMS

| Значение | Описание |
|----------|----------|
| `1` | Полученное сообщение |
| `2` | Отправленное сообщение |
| `3` | Черновик |

## Отправка SMS

### Отправка SMS-сообщения

Отправляет SMS-сообщение одному или нескольким получателям.

**Конечная точка**: `POST /api/sms/send-sms`

**Запрос**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<request>
    <Index>-1</Index>
    <Phones>
        <Phone>+48500500500</Phone>
    </Phones>
    <Sca></Sca>
    <Content>Содержимое тестового сообщения</Content>
    <Length>35</Length>
    <Reserved>1</Reserved>
    <Date>2023-01-01 12:00:00</Date>
</request>
```

#### Параметры запроса

| Параметр | Описание | Примечания |
|----------|----------|------------|
| `Index` | Индекс сообщения | Используйте -1 для новых сообщений |
| `Phones` | Номера телефонов получателей | Может содержать несколько элементов `<Phone>` |
| `Sca` | Адрес сервисного центра | Обычно пустой |
| `Content` | Текстовое содержимое сообщения | Кодировка UTF-8 |
| `Length` | Длина содержимого в символах | Должна соответствовать фактической длине |
| `Reserved` | Зарезервированное поле | Всегда устанавливается в 1 |
| `Date` | Временная метка отправки | Формат YYYY-MM-DD HH:MM:SS |

**Ответ**: `OK`

### Несколько получателей

Для отправки нескольким получателям включите несколько элементов phone:

```xml
<Phones>
    <Phone>+48500500501</Phone>
    <Phone>+48500500502</Phone>
    <Phone>+48500500503</Phone>
</Phones>
```

## Примеры использования

### Проверка количества SMS

```bash
curl -X GET http://192.168.8.1/api/sms/sms-count
```

### Получение последних сообщений

```bash
curl -X POST http://192.168.8.1/api/sms/sms-list \
     -H "Content-Type: application/xml" \
     -d '<?xml version="1.0" encoding="UTF-8"?><request><PageIndex>1</PageIndex><ReadCount>10</ReadCount><BoxType>1</BoxType><SortType>0</SortType><Ascending>0</Ascending><UnreadPreferred>1</UnreadPreferred></request>'
```

### Отправка простого SMS

```bash
curl -X POST http://192.168.8.1/api/sms/send-sms \
     -H "Content-Type: application/xml" \
     -d '<?xml version="1.0" encoding="UTF-8"?><request><Index>-1</Index><Phones><Phone>+1234567890</Phone></Phones><Sca></Sca><Content>Привет мир</Content><Length>10</Length><Reserved>1</Reserved><Date>2023-01-01 12:00:00</Date></request>'
```

## Обработка ошибок

### Распространенные коды ошибок

- **114001**: Неверный номер
- **114002**: Не удалось отправить SMS
- **114003**: Неверный номер телефона
- **114004**: Пустое содержимое SMS
- **114005**: База данных SMS полна
- **114006**: SMS уже отправлено
- **115001**: Неизвестная ошибка SMS

### Примечания по реализации

1. **Длина содержимого**: Должна точно отражать количество символов
2. **Формат телефона**: Используйте международный формат (+код страны)
3. **Кодировка**: Содержимое должно быть в кодировке UTF-8
4. **Лимиты хранилища**: Устройство может иметь ограниченное хранилище SMS
5. **Ограничение частоты**: Избегайте слишком частой отправки SMS

## Места хранения

### Локальное хранилище против SIM-карты

- **Локальное хранилище**: Внутренняя память устройства, большая емкость
- **SIM-карта**: Ограниченная емкость, переносима между устройствами

### Управление хранилищем

Отслеживайте использование хранилища для предотвращения потери сообщений:
- Регулярно проверяйте счетчики
- Удаляйте старые сообщения при заполнении хранилища
- Рассмотрите использование локального хранилища для лучшей емкости

## Соображения интеграции

### Интеграция с ModemOpus

В ModemOpus функциональность SMS используется через:
- `SmsMonitoringService` для опроса сообщений
- Паттерн репозитория для постоянства сообщений
- Фоновые службы для автоматического получения сообщений
- Службы аналитики для статистики сообщений

### Лучшие практики

1. **Регулярный опрос**: Периодически проверяйте новые сообщения
2. **Управление хранилищем**: Отслеживайте и очищайте старые сообщения
3. **Обработка ошибок**: Реализуйте логику повтора для неудачных отправок
4. **Кодировка символов**: Правильно обрабатывайте международные символы
5. **Ограничение частоты**: Соблюдайте ограничения оператора и устройства

## Связанные API

- [Monitoring API](monitoring-RU.md) - Статус устройства и подключение
- [Device API](device-RU.md) - Информация об устройстве и управление
- [Security API](security-RU.md) - Контроль доступа и аутентификация